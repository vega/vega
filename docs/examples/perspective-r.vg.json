{
  "$schema": "https://vega.github.io/schema/vega/v5.json",
  "width": 400,
  "height": 400,
  "background": "transparent",
  "title": {
    "text": "R persp emulation",
    "color": {"signal": "axis_color"},
    "dy": 25
  },
  "signals": [
    {"name": "x_sequence", "value": {"min": -1, "max": 1, "count": 30}},
    {"name": "y_sequence", "value": {"min": -1, "max": 1, "count": 30}},
    {
      "name": "scheme",
      "value": "viridis",
      "bind": {
        "input": "select",
        "options": [
          "viridis",
          "blueorange",
          "darkgold",
          "darkblue",
          "darkgreen",
          "darkmulti",
          "purplegreen",
          "spectral"
        ]
      }
    },
    {
      "name": "theme",
      "value": "dark",
      "bind": {"input": "select", "options": ["dark", "light"]}
    },
    {
      "name": "theta",
      "value": 30,
      "bind": {"input": "range", "min": -45, "max": 135, "step": 1},
      "on": [
        {"events": {"signal": "validAngle_HOR"}, "update": "validAngle_HOR"}
      ]
    },
    {
      "name": "phi",
      "value": 65,
      "bind": {"input": "range", "min": 0, "max": 180, "step": 1},
      "on": [
        {"events": {"signal": "validAngle_VER"}, "update": "validAngle_VER"}
      ]
    },
    {
      "name": "expand",
      "value": "0.5",
      "bind": {"input": "range", "min": 0, "max": 2, "step": 0.1}
    },
    {
      "name": "scale",
      "value": 1,
      "bind": {"input": "range", "min": 0, "max": 2, "step": 0.1},
      "on": [
        {
          "events": "view:mousewheel",
          "update": "max(0, min(2, scale + (event.wheelDelta > 0 ? 0.1 : -0.1)))"
        }
      ]
    },
    {"name": "axes", "value": true, "bind": {"input": "checkbox"}},
    {"name": "grid", "value": false, "bind": {"input": "checkbox"}},
    {
      "name": "grid_color",
      "value": "lightgrey",
      "bind": {"input": "select", "options": ["lightgrey", "darkgrey"]}
    },
    {"name": "axis_color", "update": "theme === 'dark' ? 'lightgrey':'black'"},
    {
      "name": "equation",
      "value": "10*sin(sqrt(x²+y²))/sqrt(x²+y²)",
      "bind": {
        "input": "select",
        "options": [
          "10*sin(sqrt(x²+y²))/sqrt(x²+y²)",
          "x*y³ - y*x³",
          "sqrt(x²+y²)",
          "tore",
          "sphere"
        ]
      }
    },
    {
      "name": "equation_id",
      "value": 1,
      "update": "equation === '10*sin(sqrt(x²+y²))/sqrt(x²+y²)' ? 1:(equation === 'x*y³ - y*x³' ? 2 : equation === 'sqrt(x²+y²)' ? 3 : equation === 'tore' ? 4: 5)"
    },
    {"name": "size", "init": "min(width,height)/2"},
    {
      "name": "is_dragging",
      "update": "false",
      "on": [
        {"events": "view:mousedown", "update": "true"},
        {
          "events": "view:mouseup, view:mousemove[event.buttons !== 1]",
          "update": "false"
        }
      ]
    },
    {
      "name": "angle_HOR",
      "on": [
        {
          "events": "view:mousemove[event.buttons === 1]",
          "update": "theta + ((event.movementX < 0) ^ (phi > 180) ? 5 : (event.movementX > 0) ^(phi > 180) ? -5 : 0)"
        }
      ]
    },
    {"name": "validAngle_HOR", "update": "max(min(angle_HOR,135),-45)"},
    {
      "name": "angle_VER",
      "on": [
        {
          "events": "view:mousemove[event.buttons === 1]",
          "update": "phi + (event.movementY < 0 ? 5 : event.movementY > 0 ? -5 : 0)"
        }
      ]
    },
    {"name": "validAngle_VER", "update": "max(min(angle_VER,180),0)"},
    {
      "name": "qrAngle_HOR",
      "init": "PI*(theta)/360",
      "on": [{"events": {"signal": "-theta"}, "update": "PI*(theta)/360"}]
    },
    {
      "name": "qrAngle_VER",
      "init": "PI*(phi)/360",
      "on": [{"events": {"signal": "phi"}, "update": "PI*(phi)/360"}]
    },
    {"name": "qrw0", "update": "cos(qrAngle_VER)"},
    {"name": "qrw1", "update": "cos(qrAngle_HOR)"},
    {"name": "qrx0", "update": "sin(qrAngle_VER)"},
    {"name": "qrz1", "update": "sin(qrAngle_HOR)"},
    {
      "name": "q",
      "update": "{x:qrx0*qrw1, y:-qrx0*qrz1, z:qrw0*qrz1, w: qrw0*qrw1}"
    },
    {"name": "q_1", "update": "{x:-q.x, y:-q.y, z: -q.z, w: q.w}"},
    {
      "name": "matrix_values",
      "init": "{}",
      "on": [
        {
          "events": "area:mouseover,line:mouseover",
          "update": "{'x':isNumber(datum.x) ? format(datum.x,'.2~f'):datum.x,'y':isNumber(datum.y) ? format(datum.y,'.2~f'):datum.y,'z':format(datum.value,'.2~f'), id:datum.id}"
        },
        {"events": "area:mouseout,line:mouseout", "update": "{}"}
      ]
    }
  ],
  "scales": [
    {
      "name": "scale_x",
      "type": "point",
      "domain": {"data": "z_matrix", "field": "x"},
      "range": [-1, 1]
    },
    {
      "name": "scale_y",
      "type": "point",
      "domain": {"data": "z_matrix", "field": "y"},
      "range": [-1, 1]
    },
    {
      "name": "scale_z",
      "type": "linear",
      "domain": {"data": "z_matrix", "field": "z"},
      "range": [{"signal": "-expand"}, {"signal": "expand"}]
    }
  ],
  "data": [
    {
      "name": "matrix",
      "values": [],
      "transform": [
        {
          "type": "sequence",
          "start": {"signal": "x_sequence.min"},
          "stop": {
            "signal": "x_sequence.max+(x_sequence.max-x_sequence.min)/(x_sequence.count-1)"
          },
          "step": {
            "signal": "(x_sequence.max-x_sequence.min)/(x_sequence.count-1)"
          },
          "as": "x"
        },
        {
          "type": "formula",
          "expr": "sequence(y_sequence.min,y_sequence.max + (y_sequence.max-y_sequence.min)/(y_sequence.count-1),(y_sequence.max-y_sequence.min)/(y_sequence.count-1))",
          "as": "y"
        },
        {"type": "flatten", "fields": ["y"]}
      ]
    },
    {
      "name": "z_matrix",
      "source": "matrix",
      "transform": [
        {
          "type": "formula",
          "expr": "equation_id === 1 ?10*sin(sqrt(pow(10*datum.x,2)+pow(10*datum.y,2)))/sqrt(pow(10*datum.x,2)+pow(10*datum.y,2)): equation_id === 2 ? datum.x*pow(datum.y,3)-datum.y*pow(datum.x,3): equation_id === 3 ? sqrt(pow(datum.x,2)+pow(datum.y,2)) : equation_id === 4 ? sqrt(0.08- pow(sqrt(pow(datum.x,2) + pow(datum.y,2)) - 0.7,2)): sqrt(1- (pow(datum.x,2)+pow(datum.y,2)))",
          "as": "z"
        }
      ]
    },
    {
      "name": "projections",
      "source": "z_matrix",
      "transform": [
        {
          "type": "collect",
          "sort": {"field": ["x", "y"], "order": ["ascending", "ascending"]}
        },
        {
          "type": "formula",
          "expr": "{x:scale('scale_x',datum.x),y:scale('scale_y',datum.y),z:scale('scale_z',isValid(datum.z) ? datum.z : 0)}",
          "as": "points"
        },
        {
          "type": "formula",
          "expr": "{x:q.w * datum.points.x + q.y*datum.points.z- q.z * datum.points.y, y:q.w * datum.points.y - q.x * datum.points.z  + q.z*datum.points.x, z:q.w * datum.points.z  + q.x*datum.points.y - q.y * datum.points.x, w: -q.x * datum.points.x - q.y * datum.points.y - q.z * datum.points.z}",
          "as": "q1"
        },
        {
          "type": "formula",
          "expr": "{x:datum.q1.w * q_1.x + datum.q1.x * q_1.w + datum.q1.y * q_1.z - datum.q1.z * q_1.y, y:datum.q1.w * q_1.y - datum.q1.x * q_1.z + datum.q1.y * q_1.w + datum.q1.z * q_1.x, z:datum.q1.w * q_1.z + datum.q1.x * q_1.y - datum.q1.y * q_1.x + datum.q1.z * q_1.w}",
          "as": "pq2"
        },
        {"type": "formula", "expr": "(datum.pq2.x)*scale*size/2", "as": "px"},
        {"type": "formula", "expr": "(datum.pq2.y)*scale*size/2", "as": "py"},
        {"type": "formula", "expr": "(datum.pq2.z)", "as": "pz"}
      ]
    },
    {
      "name": "axes",
      "values": [
        {
          "root": {"x": -1, "y": -1, "z": "-0.5"},
          "q1": {
            "x": -1.1267212479480677,
            "y": -0.48236350543356943,
            "z": -0.7635415249118548,
            "w": 0.4059914011201064
          },
          "pq2": {
            "x": -1.3289260487773493,
            "y": 0.07211258776408813,
            "z": -0.6919214778910889
          },
          "p_root": {"x": -132.89260487773493, "y": 7.211258776408814},
          "axis": [
            {"label": "x", "x": 1, "y": -1, "z": "-0.5", "isNumber": true},
            {"label": "y", "x": -1, "y": 1, "z": "-0.5", "isNumber": true},
            {"label": "z", "x": -1, "y": -1, "z": "0.5", "isNumber": true}
          ]
        }
      ],
      "transform": [
        {
          "type": "formula",
          "expr": "{x:range('scale_x')[0],y:range('scale_y')[0],z:scale('scale_z',domain('scale_z')[0])}",
          "as": "root"
        },
        {
          "type": "formula",
          "expr": "{x:q.w * datum.root.x + q.y*datum.root.z- q.z * datum.root.y, y:q.w * datum.root.y - q.x * datum.root.z  + q.z*datum.root.x, z:q.w * datum.root.z  + q.x*datum.root.y - q.y * datum.root.x, w: -q.x * datum.root.x - q.y * datum.root.y - q.z * datum.root.z}",
          "as": "q1"
        },
        {
          "type": "formula",
          "expr": "{x:datum.q1.w * q_1.x + datum.q1.x * q_1.w + datum.q1.y * q_1.z - datum.q1.z * q_1.y, y:datum.q1.w * q_1.y - datum.q1.x * q_1.z + datum.q1.y * q_1.w + datum.q1.z * q_1.x, z:datum.q1.w * q_1.z + datum.q1.x * q_1.y - datum.q1.y * q_1.x + datum.q1.z * q_1.w}",
          "as": "pq2"
        },
        {
          "type": "formula",
          "expr": "{x:(datum.pq2.x)*scale*size/2, y:(datum.pq2.y)*scale*size/2}",
          "as": "p_root"
        },
        {
          "type": "formula",
          "expr": "[{label:'x', x:range('scale_x')[1],y:range('scale_y')[0],z:scale('scale_z',domain('scale_z')[0]), 'isNumber':isNumber(domain('scale_x')[0])},{label:'y', x:range('scale_x')[0],y:range('scale_y')[1],z:scale('scale_z',domain('scale_z')[0]), 'isNumber':isNumber(domain('scale_y')[0])},{label:'z', x:range('scale_x')[0],y:range('scale_y')[0],z:scale('scale_z',domain('scale_z')[1]), 'isNumber':true}]",
          "as": "axis"
        },
        {"type": "flatten", "fields": ["axis"]},
        {
          "type": "formula",
          "expr": "{x:q.w * datum.axis.x + q.y*datum.axis.z- q.z * datum.axis.y, y:q.w * datum.axis.y - q.x * datum.axis.z  + q.z*datum.axis.x, z:q.w * datum.axis.z  + q.x*datum.axis.y - q.y * datum.axis.x, w: -q.x * datum.axis.x - q.y * datum.axis.y - q.z * datum.axis.z}",
          "as": "q1"
        },
        {
          "type": "formula",
          "expr": "{x:datum.q1.w * q_1.x + datum.q1.x * q_1.w + datum.q1.y * q_1.z - datum.q1.z * q_1.y, y:datum.q1.w * q_1.y - datum.q1.x * q_1.z + datum.q1.y * q_1.w + datum.q1.z * q_1.x, z:datum.q1.w * q_1.z + datum.q1.x * q_1.y - datum.q1.y * q_1.x + datum.q1.z * q_1.w}",
          "as": "pq2"
        },
        {
          "type": "formula",
          "expr": "{x:(datum.pq2.x)*scale*size/2, y:(datum.pq2.y)*scale*size/2}",
          "as": "p_axis"
        }
      ]
    },
    {
      "name": "areas",
      "values": [
        {
          "i": [
            1,
            2,
            3,
            4,
            5,
            6,
            7,
            8,
            9,
            10,
            11,
            12,
            13,
            14,
            15,
            16,
            17,
            18,
            19,
            20,
            21,
            22,
            23,
            24,
            25,
            26,
            27,
            28,
            29
          ],
          "j": [
            1,
            2,
            3,
            4,
            5,
            6,
            7,
            8,
            9,
            10,
            11,
            12,
            13,
            14,
            15,
            16,
            17,
            18,
            19,
            20,
            21,
            22,
            23,
            24,
            25,
            26,
            27,
            28,
            29
          ]
        }
      ],
      "transform": [
        {
          "type": "formula",
          "expr": "sequence(1,x_sequence.count,1)",
          "as": "i"
        },
        {
          "type": "formula",
          "expr": "sequence(1,y_sequence.count,1)",
          "as": "j"
        },
        {"type": "flatten", "fields": ["i"]},
        {"type": "flatten", "fields": ["j"]},
        {
          "type": "formula",
          "expr": "[((datum.i-1)*y_sequence.count+(datum.j-1)),((datum.i)*y_sequence.count+(datum.j-1)),((datum.i)*y_sequence.count+(datum.j)),((datum.i-1)*y_sequence.count+(datum.j))]",
          "as": "indice"
        },
        {
          "type": "formula",
          "expr": "[data('projections')[datum.indice[0]],data('projections')[datum.indice[1]],data('projections')[datum.indice[2]],data('projections')[datum.indice[3]],data('projections')[datum.indice[0]]]",
          "as": "item"
        },
        {
          "type": "formula",
          "expr": "(datum.item[0].pz + datum.item[1].pz + datum.item[2].pz + datum.item[3].pz)/4",
          "as": "avg_pz"
        },
        {"type": "window", "ops": ["row_number"], "as": ["id"]},
        {"type": "flatten", "fields": ["item"]},
        {
          "type": "project",
          "fields": [
            "id",
            "item.px",
            "item.py",
            "item.x",
            "item.y",
            "item.z",
            "avg_pz"
          ],
          "as": ["id", "px", "py", "x", "y", "z", "avg_pz"]
        }
      ]
    },
    {
      "name": "sorted_areas",
      "source": "areas",
      "transform": [
        {
          "type": "joinaggregate",
          "groupby": ["id"],
          "fields": ["z"],
          "ops": ["mean"],
          "as": ["value"]
        },
        {"type": "collect", "sort": {"field": "avg_pz"}}
      ]
    }
  ],
  "marks": [
    {
      "type": "rect",
      "encode": {
        "enter": {},
        "update": {
          "fill": {"signal": "theme === 'dark'?'black':'white'"},
          "cursor": [
            {"test": "is_dragging", "value": "grabbing"},
            {"value": "pointer"}
          ],
          "width": {"signal": "width"},
          "height": {"signal": "height"}
        }
      }
    },
    {
      "name": "axes_m",
      "type": "rule",
      "from": {"data": "axes"},
      "encode": {
        "enter": {"strokewidth": {"value": 1}},
        "update": {
          "stroke": {"signal": "axis_color"},
          "opacity": {"signal": "axes?1:0"},
          "x": {"field": "p_root.x", "offset": {"signal": "width/2"}},
          "y": {"field": "p_root.y", "offset": {"signal": "height/2"}},
          "x2": {"field": "p_axis.x", "offset": {"signal": "width/2"}},
          "y2": {"field": "p_axis.y", "offset": {"signal": "height/2"}}
        }
      }
    },
    {
      "type": "text",
      "from": {"data": "axes_m"},
      "encode": {
        "enter": {
          "text": {"field": "datum.axis.label"},
          "align": {"value": "center"}
        },
        "update": {
          "fill": {"signal": "axis_color"},
          "opacity": {"signal": "axes?1:0"},
          "xc": {"field": "x2"},
          "yc": {"field": "y2", "offset": -5},
          "tooltip": {
            "signal": "{'min':datum.datum.axis.isNumber?format(domain('scale_'+datum.datum.axis.label)[0],'.2~f'):domain('scale_'+datum.datum.axis.label)[0],'max':datum.datum.axis.isNumber?format(domain('scale_'+datum.datum.axis.label)[length(domain('scale_'+datum.datum.axis.label))-1],'.2~f'):domain('scale_'+datum.datum.axis.label)[length(domain('scale_'+datum.datum.axis.label))-1]}"
          }
        }
      }
    },
    {
      "type": "group",
      "from": {
        "facet": {"name": "area", "data": "sorted_areas", "groupby": ["id"]}
      },
      "data": [],
      "scales": [
        {
          "name": "color",
          "type": "linear",
          "domain": {"data": "sorted_areas", "field": "value"},
          "range": {"scheme": {"signal": "scheme"}}
        }
      ],
      "marks": [
        {
          "type": "area",
          "from": {"data": "area"},
          "encode": {
            "update": {
              "cursor": [
                {"test": "is_dragging", "value": "grabbing"},
                {"value": "pointer"}
              ],
              "fill": [
                {
                  "test": "grid || !isValid(datum.value)",
                  "value": "transparent"
                },
                {"field": "value", "scale": "color"}
              ],
              "x": {"field": "px", "offset": {"signal": "width/2"}},
              "y": {"field": "py", "offset": {"signal": "height/2"}},
              "y2": {"value": 0}
            }
          }
        },
        {
          "type": "line",
          "from": {"data": "area"},
          "encode": {
            "enter": {},
            "update": {
              "cursor": [
                {"test": "is_dragging", "value": "grabbing"},
                {"value": "pointer"}
              ],
              "strokeWidth": [{"test": "grid", "value": 0.3}, {"value": 1}],
              "stroke": [
                {"test": "grid", "signal": "grid_color"},
                {"field": "value", "scale": "color"}
              ],
              "x": {"field": "px", "offset": {"signal": "width/2"}},
              "y": {"field": "py", "offset": {"signal": "height/2"}},
              "y2": {"value": 0}
            }
          }
        }
      ]
    },
    {
      "type": "text",
      "encode": {
        "enter": {"align": {"value": "center"}},
        "update": {
          "fill": {"signal": "axis_color"},
          "xc": {"signal": "width/2"},
          "yc": {"signal": "height*0.9"},
          "text": {
            "signal": "'id: '+ matrix_values.id+', x: '+matrix_values.x+', y: '+matrix_values.y+', z: '+matrix_values.z"
          },
          "opacity": {"signal": "isValid(matrix_values.x)?1:0"}
        }
      }
    },
    {
      "type": "text",
      "encode": {
        "enter": {"x": {"value": 15}},
        "update": {
          "y": {"signal": "height*0.1"},
          "fill": {"signal": "axis_color"},
          "text": {
            "signal": "'Matrix size: '+x_sequence.count+'X'+y_sequence.count+'('+x_sequence.count*y_sequence.count+')'"
          }
        }
      }
    }
  ]
}